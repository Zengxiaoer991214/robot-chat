name: CD - Build and Deploy

on:
  # push:
  #   branches: [ "main", "release" ]
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    permissions:
      contents: read
      packages: write

    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
      
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Lowercase the repo name
      run: |
        echo "REPO_LOWER=${GITHUB_REPOSITORY,,}" >>${GITHUB_ENV}

    - name: Build and push
      uses: docker/build-push-action@v4
      with:
        context: .
        push: true
        tags: |
          ghcr.io/${{ env.REPO_LOWER }}:latest
          ghcr.io/${{ env.REPO_LOWER }}:${{ github.sha }}

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Deploy to Server via SSH
      uses: appleboy/ssh-action@master
      env:
        # Pass secrets as environment variables to the runner first
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        APP_PASSWORD: ${{ secrets.APP_PASSWORD }}
        APP_URL: ${{ vars.APP_URL }}
        # GitHub context variables need to be passed explicitly if used in the script securely
        GITHUB_ACTOR: ${{ github.actor }}
        GITHUB_REPOSITORY: ${{ github.repository }}
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        timeout: "10m"
        # Pass the environment variables from the runner to the remote server
        envs: GITHUB_TOKEN,DATABASE_URL,APP_PASSWORD,APP_URL,GITHUB_ACTOR,GITHUB_REPOSITORY
        script: |
          # 准备配置目录
          mkdir -p ~/robot-chat
          cd ~/robot-chat
          
          # 将仓库名转换为小写并导出为环境变量
          export REPO_LOWER=$(echo "$GITHUB_REPOSITORY" | tr '[:upper:]' '[:lower:]')
          
          # 创建 .env 文件用于 docker-compose
          cat > .env <<EOF
          REPO_LOWER=$REPO_LOWER
          DATABASE_URL=$DATABASE_URL
          APP_PASSWORD=$APP_PASSWORD
          APP_URL=$APP_URL
          EOF

          # 写入 docker-compose.prod.yml
          cat > docker-compose.yml <<'EOF'
          version: '3.8'

          services:
            backend:
              image: ghcr.io/${REPO_LOWER}-backend:latest
              container_name: robot-chat-backend
              restart: unless-stopped
              # 添加 host.docker.internal 映射，允许容器访问宿主机网络
              extra_hosts:
                - "host.docker.internal:host-gateway"
              environment:
                - APP_PORT=8000
                - DATABASE_URL=${DATABASE_URL}
                - APP_PASSWORD=${APP_PASSWORD}
                - APP_URL=${APP_URL}
                # 代理配置：指向宿主机的 7890 端口
                # 注意：宿主机上的代理软件必须允许局域网连接 (Allow LAN) 或监听 0.0.0.0
                - HTTP_PROXY=http://host.docker.internal:7890
                - HTTPS_PROXY=http://host.docker.internal:7890
                - http_proxy=http://host.docker.internal:7890
                - https_proxy=http://host.docker.internal:7890
                # 避免内部服务走代理
                - NO_PROXY=localhost,127.0.0.1,::1,robot-chat-backend,robot-chat-frontend,backend,frontend
              ports:
                - "9811:8000"
              networks:
                - robot-chat-net

            frontend:
              image: ghcr.io/${REPO_LOWER}-frontend:latest
              container_name: robot-chat-frontend
              restart: unless-stopped
              ports:
                - "9812:80"
              depends_on:
                - backend
              networks:
                - robot-chat-net

          networks:
            robot-chat-net:
              driver: bridge
          EOF
          
          # 登录 Docker Registry
          echo "$GITHUB_TOKEN" | docker login ghcr.io -u "$GITHUB_ACTOR" --password-stdin
          
          # 拉取最新镜像
          docker compose pull
          
          # 启动服务
          docker compose up -d --remove-orphans
          
          # 清理无用的镜像
          docker image prune -f
