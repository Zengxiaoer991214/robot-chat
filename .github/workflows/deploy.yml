name: CD - Build and Deploy

on:
  push:
    branches: [ "main", "release" ]
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    permissions:
      contents: read
      packages: write

    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
      
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Lowercase the repo name
      run: |
        echo "REPO_LOWER=${GITHUB_REPOSITORY,,}" >>${GITHUB_ENV}

    - name: Build and push
      uses: docker/build-push-action@v4
      with:
        context: .
        push: true
        tags: |
          ghcr.io/${{ env.REPO_LOWER }}:latest
          ghcr.io/${{ env.REPO_LOWER }}:${{ github.sha }}

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: Deploy to Server via SSH
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        timeout: "10m"
        script: |
          # 准备配置目录
          mkdir -p ~/robot-chat/config
          
          # 将仓库名转换为小写 (bash 4.0+)
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          
          # 登录 Docker Registry
          export http_proxy=""
          export https_proxy=""
          
          echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          
          # 拉取最新镜像
          docker pull ghcr.io/$REPO_LOWER:latest
          
          # 停止并删除旧容器
          docker stop robot-chat || true
          docker rm robot-chat || true
          
          # 启动新容器
          # 使用 host 网络模式，以便容器可以访问宿主机的代理 (127.0.0.1:7890)
          # 设置 APP_PORT 环境变量为 9009
          
          docker run -d \
            --name robot-chat \
            --restart unless-stopped \
            --network host \
            -e APP_PORT=9009 \
            -e DATABASE_URL="${{ secrets.DATABASE_URL }}" \
            -e APP_PASSWORD="${{ secrets.APP_PASSWORD }}" \
            -e APP_URL="${{ vars.APP_URL }}" \
            ghcr.io/$REPO_LOWER:latest
